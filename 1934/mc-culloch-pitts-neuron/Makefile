# Makefile para gestiÃ³n del entorno virtual Python
# Proyecto: McCulloch-Pitts Neuron (1934)

# Variables
VENV_NAME := venv
PYTHON := python
VENV_BIN := $(VENV_NAME)/bin
VENV_PYTHON := $(VENV_BIN)/python
VENV_PIP := $(VENV_BIN)/pip
REQ_FILE := requirements.txt

# Colores para mensajes
GREEN := \033[0;32m
YELLOW := \033[0;33m
BLUE := \033[0;34m
RED := \033[0;31m
RESET := \033[0m

# Target por defecto
.DEFAULT_GOAL := help

# Phony targets (no son archivos reales)
.PHONY: help venv activate install install-dev freeze update clean test run info status

# Ayuda: muestra todos los comandos disponibles
help:
	@printf "$(BLUE)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(RESET)\n"
	@printf "$(BLUE)â•‘  Makefile - McCulloch-Pitts Neuron Environment    â•‘$(RESET)\n"
	@printf "$(BLUE)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(RESET)\n\n"
	@printf "$(GREEN)Comandos de Entorno Virtual:$(RESET)\n"
	@printf "  $(YELLOW)make venv$(RESET)          - Crea el entorno virtual\n"
	@printf "  $(YELLOW)make activate$(RESET)      - Muestra cÃ³mo activar el entorno\n"
	@printf "  $(YELLOW)make shell$(RESET)         - Abre una shell con el entorno activado\n\n"
	@printf "$(GREEN)GestiÃ³n de Dependencias:$(RESET)\n"
	@printf "  $(YELLOW)make install$(RESET)       - Instala dependencias desde requirements.txt\n"
	@printf "  $(YELLOW)make install-dev$(RESET)   - Instala dependencias de desarrollo\n"
	@printf "  $(YELLOW)make freeze$(RESET)        - Guarda dependencias actuales\n"
	@printf "  $(YELLOW)make update$(RESET)        - Actualiza todas las dependencias\n\n"
	@printf "$(GREEN)Utilidades:$(RESET)\n"
	@printf "  $(YELLOW)make info$(RESET)          - InformaciÃ³n del entorno virtual\n"
	@printf "  $(YELLOW)make status$(RESET)        - Estado del entorno y paquetes instalados\n"
	@printf "  $(YELLOW)make test$(RESET)          - Ejecuta pruebas (si existen)\n"
	@printf "  $(YELLOW)make run$(RESET)           - Ejecuta el programa principal\n"
	@printf "  $(YELLOW)make clean$(RESET)         - Limpia archivos temporales\n"
	@printf "  $(YELLOW)make clean-venv$(RESET)    - Elimina el entorno virtual\n"
	@printf "  $(YELLOW)make reset$(RESET)         - Recrea el entorno desde cero\n\n"
	@printf "$(GREEN)Ejemplo de uso:$(RESET)\n"
	@printf "  1. make venv              # Crear entorno\n"
	@printf "  2. make install           # Instalar dependencias\n"
	@printf "  3. make shell             # Trabajar en el entorno\n"
	@printf "  4. exit                   # Salir del entorno\n\n"

# Crea el entorno virtual
venv: $(VENV_NAME)/bin/activate

$(VENV_NAME)/bin/activate:
	@printf "$(GREEN)ğŸ“¦ Creando entorno virtual...$(RESET)\n"
	$(PYTHON) -m venv $(VENV_NAME)
	@printf "$(GREEN)âœ… Entorno virtual creado en: $(VENV_NAME)/$(RESET)\n"
	@printf "$(YELLOW)ğŸ’¡ Usa 'make activate' para ver cÃ³mo activarlo$(RESET)\n"

# Muestra instrucciones para activar manualmente
activate:
	@printf "$(BLUE)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(RESET)\n"
	@printf "$(BLUE)â•‘  Para ACTIVAR el entorno virtual manualmente:     â•‘$(RESET)\n"
	@printf "$(BLUE)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(RESET)\n\n"
	@printf "$(GREEN)En Linux/Mac:$(RESET)\n"
	@printf "  source $(VENV_NAME)/bin/activate\n\n"
	@printf "$(GREEN)En Windows (CMD):$(RESET)\n"
	@printf "  $(VENV_NAME)\\Scripts\\activate.bat\n\n"
	@printf "$(GREEN)En Windows (PowerShell):$(RESET)\n"
	@printf "  $(VENV_NAME)\\Scripts\\Activate.ps1\n\n"
	@printf "$(YELLOW)ğŸ’¡ Mejor opciÃ³n: usa 'make shell' para abrir una shell con el entorno activado$(RESET)\n\n"
	@printf "$(BLUE)Para DESACTIVAR:$(RESET)\n"
	@printf "  deactivate\n\n"

# Abre una nueva shell con el entorno virtual activado
shell: venv
	@printf "$(GREEN)ğŸš Abriendo shell con entorno virtual activado...$(RESET)\n"
	@printf "$(YELLOW)ğŸ’¡ Escribe 'exit' para salir y desactivar el entorno$(RESET)\n\n"
	@bash --init-file <(echo ". $(HOME)/.bashrc 2>/dev/null || true; source $(VENV_BIN)/activate; \
		printf '$(GREEN)âœ… Entorno virtual activado$(RESET)\n'; \
		printf '$(YELLOW)ğŸ“ UbicaciÃ³n: $(shell pwd)/$(VENV_NAME)$(RESET)\n'; \
		printf '$(BLUE)ğŸ Python: $$($(VENV_PYTHON) --version)$(RESET)\n\n'; \
		PS1='(venv) \[\033[01;32m\]\u@\h\[\033[00m\]:\[\033[01;34m\]\w\[\033[00m\]\$$ '")

# Instala las dependencias desde requirements.txt
install: venv
	@if [ -f "$(REQ_FILE)" ]; then \
		printf "$(GREEN)ğŸ“¥ Instalando dependencias desde $(REQ_FILE)...$(RESET)\n"; \
		$(VENV_PIP) install --upgrade pip; \
		$(VENV_PIP) install -r $(REQ_FILE); \
		printf "$(GREEN)âœ… Dependencias instaladas$(RESET)\n"; \
	else \
		printf "$(YELLOW)âš ï¸  No existe $(REQ_FILE)$(RESET)\n"; \
		printf "$(BLUE)ğŸ’¡ Crea el archivo o usa 'make install-dev' para instalar paquetes bÃ¡sicos$(RESET)\n"; \
	fi

# Instala dependencias de desarrollo
install-dev: venv
	@printf "$(GREEN)ğŸ“¥ Instalando dependencias de desarrollo...$(RESET)\n"
	$(VENV_PIP) install --upgrade pip
	$(VENV_PIP) install numpy matplotlib pytest black flake8 ipython jupyter
	@printf "$(GREEN)âœ… Dependencias de desarrollo instaladas$(RESET)\n"
	@printf "$(YELLOW)ğŸ’¡ Usa 'make freeze' para guardar las dependencias$(RESET)\n"

# Guarda las dependencias actuales en requirements.txt
freeze: venv
	@printf "$(GREEN)ğŸ’¾ Guardando dependencias en $(REQ_FILE)...$(RESET)\n"
	$(VENV_PIP) freeze > $(REQ_FILE)
	@printf "$(GREEN)âœ… Dependencias guardadas$(RESET)\n\n"
	@printf "$(BLUE)Contenido de $(REQ_FILE):$(RESET)\n"
	@cat $(REQ_FILE)

# Actualiza todas las dependencias
update: venv
	@printf "$(GREEN)ğŸ”„ Actualizando pip...$(RESET)\n"
	$(VENV_PIP) install --upgrade pip
	@if [ -f "$(REQ_FILE)" ]; then \
		printf "$(GREEN)ğŸ”„ Actualizando dependencias...$(RESET)\n"; \
		$(VENV_PIP) install --upgrade -r $(REQ_FILE); \
		printf "$(GREEN)âœ… Dependencias actualizadas$(RESET)\n"; \
		printf "$(YELLOW)ğŸ’¡ Usa 'make freeze' para guardar las nuevas versiones$(RESET)\n"; \
	else \
		printf "$(YELLOW)âš ï¸  No existe $(REQ_FILE)$(RESET)\n"; \
	fi

# Muestra informaciÃ³n del entorno virtual
info: venv
	@printf "$(BLUE)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(RESET)\n"
	@printf "$(BLUE)â•‘  InformaciÃ³n del Entorno Virtual                  â•‘$(RESET)\n"
	@printf "$(BLUE)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(RESET)\n\n"
	@printf "$(GREEN)ğŸ“ UbicaciÃ³n:$(RESET) $(shell pwd)/$(VENV_NAME)\n"
	@printf "$(GREEN)ğŸ Python:$(RESET) $(shell $(VENV_PYTHON) --version)\n"
	@printf "$(GREEN)ğŸ“¦ pip:$(RESET) versiÃ³n $(shell $(VENV_PIP) --version | cut -d' ' -f2)\n"
	@printf "$(GREEN)ğŸ”§ Ejecutable:$(RESET) $(shell readlink -f $(VENV_PYTHON))\n\n"
	@printf "$(BLUE)Variables de entorno:$(RESET)\n"
	@$(VENV_PYTHON) -c "import sys; print('  VIRTUAL_ENV:', '$(shell pwd)/$(VENV_NAME)')"
	@$(VENV_PYTHON) -c "import sys; print('  sys.prefix:', sys.prefix)"
	@printf "\n"

# Muestra el estado y paquetes instalados
status: venv
	@printf "$(BLUE)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(RESET)\n"
	@printf "$(BLUE)â•‘  Estado del Entorno Virtual                       â•‘$(RESET)\n"
	@printf "$(BLUE)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(RESET)\n\n"
	@if [ -d "$(VENV_NAME)" ]; then \
		printf "$(GREEN)âœ… Entorno virtual: CREADO$(RESET)\n\n"; \
	else \
		printf "$(YELLOW)âŒ Entorno virtual: NO CREADO$(RESET)\n\n"; \
	fi
	@printf "$(BLUE)ğŸ“¦ Paquetes instalados:$(RESET)\n"
	@$(VENV_PIP) list
	@printf "\n$(BLUE)ğŸ“Š Total de paquetes:$(RESET) $(shell $(VENV_PIP) list | tail -n +3 | wc -l)\n"

# Ejecuta pruebas (si existen)
test: venv
	@if [ -d "tests" ] || [ -f "test_*.py" ]; then \
		printf "$(GREEN)ğŸ§ª Ejecutando pruebas...$(RESET)\n"; \
		$(VENV_PYTHON) -m pytest -v; \
	else \
		printf "$(YELLOW)âš ï¸  No se encontraron pruebas$(RESET)\n"; \
		printf "$(BLUE)ğŸ’¡ Crea archivos test_*.py o un directorio tests/$(RESET)\n"; \
	fi

# Ejecuta el programa principal
run: venv
	@if [ -f "main.py" ]; then \
		printf "$(GREEN)ğŸš€ Ejecutando main.py...$(RESET)\n"; \
		$(VENV_PYTHON) main.py; \
	elif [ -f "mcculloch_pitts.py" ]; then \
		printf "$(GREEN)ğŸš€ Ejecutando mcculloch_pitts.py...$(RESET)\n"; \
		$(VENV_PYTHON) mcculloch_pitts.py; \
	else \
		printf "$(YELLOW)âš ï¸  No se encontrÃ³ archivo principal$(RESET)\n"; \
		printf "$(BLUE)ğŸ’¡ Crea main.py o especifica el archivo:$(RESET)\n"; \
		printf "    $(VENV_PYTHON) tu_archivo.py\n"; \
	fi

# Limpia archivos temporales
clean:
	@printf "$(GREEN)ğŸ§¹ Limpiando archivos temporales...$(RESET)\n"
	@find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
	@find . -type f -name "*.pyc" -delete 2>/dev/null || true
	@find . -type f -name "*.pyo" -delete 2>/dev/null || true
	@find . -type d -name "*.egg-info" -exec rm -rf {} + 2>/dev/null || true
	@find . -type d -name ".pytest_cache" -exec rm -rf {} + 2>/dev/null || true
	@find . -type d -name ".coverage" -exec rm -rf {} + 2>/dev/null || true
	@find . -type d -name "htmlcov" -exec rm -rf {} + 2>/dev/null || true
	@printf "$(GREEN)âœ… Limpieza completada$(RESET)\n"

# Elimina el entorno virtual
clean-venv:
	@printf "$(YELLOW)âš ï¸  Â¿EstÃ¡s seguro de eliminar el entorno virtual?$(RESET)\n"
	@printf "$(YELLOW)   Presiona Ctrl+C para cancelar o Enter para continuar...$(RESET)\n"
	@read confirm
	@printf "$(GREEN)ğŸ—‘ï¸  Eliminando entorno virtual...$(RESET)\n"
	@rm -rf $(VENV_NAME)
	@printf "$(GREEN)âœ… Entorno virtual eliminado$(RESET)\n"

# Recrea el entorno virtual desde cero
reset: clean-venv venv install
	@printf "$(GREEN)âœ… Entorno recreado exitosamente$(RESET)\n"

# VerificaciÃ³n de dependencias del sistema
check:
	@printf "$(BLUE)ğŸ” Verificando dependencias del sistema...$(RESET)\n\n"
	@command -v python >/dev/null 2>&1 && \
		printf "$(GREEN)âœ… Python: $(shell python --version)$(RESET)\n" || \
		printf "$(RED)âŒ Python no encontrado$(RESET)\n"
	@command -v pip >/dev/null 2>&1 && \
		printf "$(GREEN)âœ… pip: instalado$(RESET)\n" || \
		printf "$(RED)âŒ pip no encontrado$(RESET)\n"
	@python -m venv --help >/dev/null 2>&1 && \
		printf "$(GREEN)âœ… venv: disponible$(RESET)\n" || \
		printf "$(RED)âŒ venv no disponible$(RESET)\n"
	@printf "\n"

# Instala un paquete especÃ­fico (uso: make add PKG=numpy)
add: venv
	@if [ -z "$(PKG)" ]; then \
		printf "$(YELLOW)âš ï¸  Debes especificar un paquete$(RESET)\n"; \
		printf "$(BLUE)Uso: make add PKG=nombre_paquete$(RESET)\n"; \
		printf "$(BLUE)Ejemplo: make add PKG=numpy$(RESET)\n"; \
	else \
		printf "$(GREEN)ğŸ“¥ Instalando $(PKG)...$(RESET)\n"; \
		$(VENV_PIP) install $(PKG); \
		printf "$(GREEN)âœ… $(PKG) instalado$(RESET)\n"; \
		printf "$(YELLOW)ğŸ’¡ Usa 'make freeze' para guardar en requirements.txt$(RESET)\n"; \
	fi

# Desinstala un paquete especÃ­fico (uso: make remove PKG=numpy)
remove: venv
	@if [ -z "$(PKG)" ]; then \
		printf "$(YELLOW)âš ï¸  Debes especificar un paquete$(RESET)\n"; \
		printf "$(BLUE)Uso: make remove PKG=nombre_paquete$(RESET)\n"; \
		printf "$(BLUE)Ejemplo: make remove PKG=numpy$(RESET)\n"; \
	else \
		printf "$(GREEN)ğŸ—‘ï¸  Desinstalando $(PKG)...$(RESET)\n"; \
		$(VENV_PIP) uninstall -y $(PKG); \
		printf "$(GREEN)âœ… $(PKG) desinstalado$(RESET)\n"; \
		printf "$(YELLOW)ğŸ’¡ Usa 'make freeze' para actualizar requirements.txt$(RESET)\n"; \
	fi

# Abre Jupyter Notebook (si estÃ¡ instalado)
jupyter: venv
	@if $(VENV_PIP) show jupyter >/dev/null 2>&1; then \
		printf "$(GREEN)ğŸ““ Iniciando Jupyter Notebook...$(RESET)\n"; \
		$(VENV_BIN)/jupyter notebook; \
	else \
		printf "$(YELLOW)âš ï¸  Jupyter no estÃ¡ instalado$(RESET)\n"; \
		printf "$(BLUE)ğŸ’¡ InstÃ¡lalo con: make add PKG=jupyter$(RESET)\n"; \
	fi

# Muestra el tamaÃ±o del entorno virtual
size:
	@if [ -d "$(VENV_NAME)" ]; then \
		printf "$(BLUE)ğŸ“Š TamaÃ±o del entorno virtual:$(RESET)\n"; \
		du -sh $(VENV_NAME); \
	else \
		printf "$(YELLOW)âš ï¸  El entorno virtual no existe$(RESET)\n"; \
	fi
